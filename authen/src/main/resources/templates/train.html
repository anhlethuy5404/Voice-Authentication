<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Training Dashboard</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>

<body class="bg-light">
    <div class="container py-4">
        <div class="card shadow-lg">
            <div class="card-body p-4">
                <!-- Header -->
                <div class="border-bottom border-3 border-primary pb-3 mb-4">
                    <h1 class="display-5 fw-bold mb-2">
                        <i class="bi bi-cpu"></i> Model Training Dashboard
                    </h1>
                    <p class="text-muted mb-0">Real-time training monitoring and configuration</p>

                    <!--                    &lt;!&ndash; üîç DEBUG: Check if config exists &ndash;&gt;-->
                    <!--                    <small class="text-danger" th:if="${config == null}">‚ö†Ô∏è Config is NULL!</small>-->
                    <!--                    <small class="text-success" th:if="${config != null}">‚úÖ Config loaded: <span-->
                    <!--                            th:text="${config}"></span></small>-->
                </div>

                <!-- Status Progress Section -->
                <div class="alert alert-primary mb-4" id="statusSection">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h5 class="mb-1">
                                <i class="bi bi-hourglass-split" id="statusIcon"></i>
                                Training Status
                            </h5>
                            <p class="mb-0" id="statusMessage">Waiting to start...</p>
                        </div>
                        <span class="badge bg-secondary" id="statusStage">IDLE</span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="statusProgressBar"
                            role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0"
                            aria-valuemax="100">0%</div>
                    </div>
                </div>

                <!-- Info Messages Section -->
                <div class="mb-4">
                    <h5 class="mb-3"><i class="bi bi-info-circle"></i> Information Log</h5>
                    <div class="border rounded" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 10%">#</th>
                                    <th style="width: 20%">Time</th>
                                    <th style="width: 70%">Message</th>
                                </tr>
                            </thead>
                            <tbody id="infoTableBody">
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No information messages yet...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Epoch Training Results Section -->
                <div class="mb-4">
                    <h5 class="mb-3"><i class="bi bi-graph-up"></i> Training Progress</h5>
                    <div class="border rounded" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-striped mb-0">
                            <thead class="table-primary sticky-top">
                                <tr>
                                    <th style="width: 15%">Epoch</th>
                                    <th style="width: 20%">Train Loss</th>
                                    <th style="width: 20%">Val Loss</th>
                                    <th style="width: 20%">Train Acc</th>
                                    <th style="width: 25%">Val Acc</th>
                                </tr>
                            </thead>
                            <tbody id="epochTableBody">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No epoch data yet...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Success Message Alert -->
                <div th:if="${message}" class="alert alert-info alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle"></i> <span th:text="${message}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Completed Modal -->
    <div class="modal fade" id="completedModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle"></i> Training Completed Successfully!
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success" id="completedMessage">
                        Training finished successfully!
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="card text-center mb-3">
                                <div class="card-body">
                                    <div class="display-6 text-primary fw-bold" id="bestValLoss">-</div>
                                    <div class="text-muted small text-uppercase">Best Val Loss</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center mb-3">
                                <div class="card-body">
                                    <div class="display-6 text-primary fw-bold" id="finalEpoch">-</div>
                                    <div class="text-muted small text-uppercase">Final Epoch</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center mb-3">
                                <div class="card-body">
                                    <div class="display-6 text-primary fw-bold" id="testAccuracy">-</div>
                                    <div class="text-muted small text-uppercase">Test Accuracy</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h6 class="mt-4 mb-3"><i class="bi bi-clipboard-data"></i> Test Results</h6>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Accuracy</strong></td>
                                <td id="testAccuracyDetail">-</td>
                            </tr>
                            <tr>
                                <td><strong>Precision</strong></td>
                                <td id="testPrecision">-</td>
                            </tr>
                            <tr>
                                <td><strong>Recall</strong></td>
                                <td id="testRecall">-</td>
                            </tr>
                            <tr>
                                <td><strong>F1 Score</strong></td>
                                <td id="testF1">-</td>
                            </tr>
                            <tr>
                                <td><strong>Test Loss</strong></td>
                                <td id="testLoss">-</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="alert alert-info">
                        <strong><i class="bi bi-save"></i> Checkpoint:</strong><br>
                        <code id="checkpointPath">-</code>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                        <i class="bi bi-arrow-left"></i> Back
                    </button>
                    <button type="button" class="btn btn-primary" id="saveResultBtn">
                        <i class="bi bi-save"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div> <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle"></i> Training Error
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger mb-0" id="errorMessage">
                        An error occurred during training.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- WebSocket & Real-time Updates -->
    <script>
        let infoCounter = 0;
        let epochCounter = 0;
        let ws = null;
        let trainingStarted = false;
        let COMPLETE_TRAINING_DATA = null;  // ‚úÖ L∆∞u to√†n b·ªô data khi training xong

        // WebSocket connection function
        function connectWebSocket() {
            // Connect to Spring Boot WebSocket endpoint (you'll need to create this)
            ws = new WebSocket('ws://localhost:8080/ws/training-updates');

            ws.onopen = function () {
                console.log('‚úÖ WebSocket connected');
                updateStatus('Connected to training server', 'CONNECTED', 10);
            };

            ws.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (e) {
                    console.error('Failed to parse message:', e);
                }
            };

            ws.onerror = function (error) {
                console.error('‚ùå WebSocket error:', error);
                showError('WebSocket connection error');
            };

            ws.onclose = function () {
                console.log('üîå WebSocket disconnected');
                if (trainingStarted) {
                    setTimeout(connectWebSocket, 3000); // Reconnect after 3s
                }
            };
        }

        // Handle different message types
        function handleMessage(data) {
            const type = data.type;

            switch (type) {
                case 'status':
                    handleStatusMessage(data);
                    break;
                case 'info':
                    handleInfoMessage(data);
                    break;
                case 'epoch':
                    handleEpochMessage(data);
                    break;
                case 'completed':
                    console.log('üéâ Received COMPLETED message:', data);
                    handleCompletedMessage(data);
                    break;
                case 'error':
                    handleErrorMessage(data);
                    break;
                default:
                    console.warn('Unknown message type:', type);
            }
        }

        // STATUS handler
        function handleStatusMessage(data) {
            const message = data.message || 'Processing...';
            const stage = data.stage || 'UNKNOWN';
            const progress = data.progress || 0;

            updateStatus(message, stage, progress);
        }

        function updateStatus(message, stage, progress) {
            document.getElementById('statusMessage').textContent = message;
            document.getElementById('statusStage').textContent = stage;

            const progressBar = document.getElementById('statusProgressBar');
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';

            // Change color based on stage
            const statusSection = document.getElementById('statusSection');
            if (stage === 'COMPLETED') {
                statusSection.className = 'alert alert-success mb-4';
                document.getElementById('statusIcon').className = 'bi bi-check-circle';
                document.getElementById('statusStage').className = 'badge bg-success';
            } else if (stage === 'ERROR') {
                statusSection.className = 'alert alert-danger mb-4';
                document.getElementById('statusIcon').className = 'bi bi-exclamation-triangle';
                document.getElementById('statusStage').className = 'badge bg-danger';
            } else if (stage === 'TRAINING') {
                statusSection.className = 'alert alert-info mb-4';
                document.getElementById('statusIcon').className = 'bi bi-arrow-repeat';
                document.getElementById('statusStage').className = 'badge bg-info';
            }
        }

        // INFO handler
        function handleInfoMessage(data) {
            const message = data.message || '';
            const timestamp = new Date().toLocaleTimeString();

            infoCounter++;

            const tbody = document.getElementById('infoTableBody');

            if (infoCounter === 1) {
                const placeholder = tbody.querySelector('td[colspan]');
                if (placeholder) {
                    tbody.innerHTML = '';
                }
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${infoCounter}</td>
                <td><span class="badge bg-info">${timestamp}</span></td>
                <td>${message}</td>
            `;

            tbody.appendChild(row);

            // Auto scroll to bottom
            const container = tbody.closest('div[style*="overflow-y"]');
            container.scrollTop = container.scrollHeight;

            console.log(`‚ÑπÔ∏è INFO #${infoCounter}: ${message}`);
        }

        // EPOCH handler
        function handleEpochMessage(data) {
            const epoch = data.epoch || 0;
            const totalEpochs = data.total_epochs || 0;
            const trainLoss = data.train_loss ? data.train_loss.toFixed(4) : '-';
            const valLoss = data.val_loss ? data.val_loss.toFixed(4) : '-';
            const trainAcc = data.train_acc ? (data.train_acc * 100).toFixed(2) + '%' : '-';
            const valAcc = data.val_acc ? (data.val_acc * 100).toFixed(2) + '%' : '-';

            const tbody = document.getElementById('epochTableBody');
            if (tbody.querySelector('td[colspan]')) {
                tbody.innerHTML = '';
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${epoch} / ${totalEpochs}</strong></td>
                <td class="text-danger fw-bold font-monospace">${trainLoss}</td>
                <td class="text-warning fw-bold font-monospace">${valLoss}</td>
                <td class="text-success fw-bold font-monospace">${trainAcc}</td>
                <td class="text-success fw-bold font-monospace">${valAcc}</td>
            `;

            tbody.appendChild(row);

            // Update status progress based on epoch
            const progress = Math.round((epoch / totalEpochs) * 100);
            updateStatus(`Training epoch ${epoch}/${totalEpochs}`, 'TRAINING', progress);

            // Auto scroll to bottom
            const container = tbody.closest('div[style*="overflow-y"]');
            container.scrollTop = container.scrollHeight;
        }

        // COMPLETED handler
        function handleCompletedMessage(data) {
            trainingStarted = false;

            // ‚úÖ L∆ØU TO√ÄN B·ªò DATA V√ÄO BI·∫æN GLOBAL
            COMPLETE_TRAINING_DATA = data;

            console.log('========== COMPLETED MESSAGE ==========');
            console.log('üì¶ Full data:', data);
            console.log('üìã Data keys:', Object.keys(data));
            console.log('üîç model_name:', data.model_name);
            console.log('üîç model_type:', data.model_type);
            console.log('üîç version:', data.version);
            console.log('üîç hyperparameters:', data.hyperparameters);
            console.log('üîç train_logs:', data.train_logs);
            console.log('üîç started_at:', data.started_at);
            console.log('üîç finished_at:', data.finished_at);
            console.log('üîç duration_seconds:', data.duration_seconds);
            console.log('========================================');

            const message = data.message || 'Training completed successfully!';
            const bestValLoss = data.best_val_loss ? data.best_val_loss.toFixed(4) : '-';
            const finalEpoch = data.final_epoch || '-';
            const checkpointPath = data.checkpoint_path || '-';

            // Test results
            const testResults = data.test_results || {};
            const testAcc = testResults.accuracy ? (testResults.accuracy * 100).toFixed(2) + '%' : '-';
            const testPrecision = testResults.precision ? (testResults.precision * 100).toFixed(2) + '%' : '-';
            const testRecall = testResults.recall ? (testResults.recall * 100).toFixed(2) + '%' : '-';
            const testF1 = testResults.f1 ? (testResults.f1 * 100).toFixed(2) + '%' : '-';
            const testLoss = testResults.loss ? testResults.loss.toFixed(4) : '-';

            // Update modal content
            document.getElementById('completedMessage').textContent = message;
            document.getElementById('bestValLoss').textContent = bestValLoss;
            document.getElementById('finalEpoch').textContent = finalEpoch;
            document.getElementById('testAccuracy').textContent = testAcc;
            document.getElementById('testAccuracyDetail').textContent = testAcc;
            document.getElementById('testPrecision').textContent = testPrecision;
            document.getElementById('testRecall').textContent = testRecall;
            document.getElementById('testF1').textContent = testF1;
            document.getElementById('testLoss').textContent = testLoss;
            document.getElementById('checkpointPath').textContent = checkpointPath;

            // Update status
            updateStatus(message, 'COMPLETED', 100);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('completedModal'));
            modal.show();
        }

        // ERROR handler
        function handleErrorMessage(data) {
            trainingStarted = false;
            const message = data.message || 'An error occurred during training';

            showError(message);
            updateStatus(message, 'ERROR', 0);
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('errorModal'));
            modal.show();
        }

        // Initialize WebSocket on page load
        window.addEventListener('load', function () {
            connectWebSocket();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function () {
            if (ws) {
                ws.close();
            }
        });

        // ‚úÖ SAVE BUTTON HANDLER
        document.addEventListener('DOMContentLoaded', function () {
            const saveBtn = document.getElementById('saveResultBtn');

            if (saveBtn) {
                saveBtn.addEventListener('click', function () {
                    // Ki·ªÉm tra c√≥ data kh√¥ng
                    if (!COMPLETE_TRAINING_DATA) {
                        alert('‚ö†Ô∏è No training data to save!');
                        return;
                    }

                    console.log('üì§ Sending data to backend:', COMPLETE_TRAINING_DATA);

                    // Disable button ƒë·ªÉ tr√°nh click nhi·ªÅu l·∫ßn
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

                    // G·ª≠i POST request
                    fetch('/admin/train/save-result', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(COMPLETE_TRAINING_DATA)
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to save: ' + response.statusText);
                            }
                            return response.json();
                        })
                        .then(result => {
                            console.log('‚úÖ Save successful:', result);

                            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                            alert('‚úÖ Model saved successfully!');

                            // ƒê√≥ng modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById('completedModal'));
                            if (modal) {
                                modal.hide();
                            }

                            // Redirect v·ªÅ trang admin
                            setTimeout(() => {
                                window.location.href = '/admin/setup';
                            }, 500);
                        })
                        .catch(error => {
                            console.error('‚ùå Save failed:', error);
                            alert('‚ùå Failed to save model: ' + error.message);

                            // Enable l·∫°i button
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = '<i class="bi bi-save"></i> Save';
                        });
                });
            }
        });
    </script>
</body>

</html>